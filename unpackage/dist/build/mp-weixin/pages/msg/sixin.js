(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/msg/sixin"],{"28c3":function(t,e,n){"use strict";n.d(e,"b",(function(){return o})),n.d(e,"c",(function(){return a})),n.d(e,"a",(function(){return i}));var i={uNavbar:function(){return n.e("uview-ui/components/u-navbar/u-navbar").then(n.bind(null,"2122"))},uSticky:function(){return n.e("uview-ui/components/u-sticky/u-sticky").then(n.bind(null,"8564"))},uNoticeBar:function(){return n.e("uview-ui/components/u-notice-bar/u-notice-bar").then(n.bind(null,"bfe2"))},uImage:function(){return n.e("uview-ui/components/u-image/u-image").then(n.bind(null,"4bb9"))},uInput:function(){return Promise.all([n.e("common/vendor"),n.e("uview-ui/components/u-input/u-input")]).then(n.bind(null,"7fd0"))},uButton:function(){return n.e("uview-ui/components/u-button/u-button").then(n.bind(null,"5352"))}},o=function(){var t=this,e=t.$createElement,n=(t._self._c,t.__map(t.talkList,(function(e,n){var i=t.__get_orig(e),o=t.formatMssageTime(e,n);return{$orig:i,m0:o}})));t.$mp.data=Object.assign({},{$root:{l0:n}})},a=[]},"5c31":function(t,e,n){},"8f94":function(t,e,n){"use strict";n.r(e);var i=n("e44d"),o=n.n(i);for(var a in i)"default"!==a&&function(t){n.d(e,t,(function(){return i[t]}))}(a);e["default"]=o.a},"91a8":function(t,e,n){"use strict";n.r(e);var i=n("28c3"),o=n("8f94");for(var a in o)"default"!==a&&function(t){n.d(e,t,(function(){return o[t]}))}(a);n("9df1");var r,s=n("f0c5"),u=Object(s["a"])(o["default"],i["b"],i["c"],!1,null,null,null,!1,i["a"],r);e["default"]=u.exports},"9df1":function(t,e,n){"use strict";var i=n("5c31"),o=n.n(i);o.a},df0f:function(t,e,n){"use strict";(function(t){n("66ba");i(n("66fd"));var e=i(n("91a8"));function i(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=n,t(e.default)}).call(this,n("543d")["createPage"])},e44d:function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=r(n("a34a")),o=n("26cb"),a=(r(n("03e9")),r(n("3ea0")));n("feab");function r(t){return t&&t.__esModule?t:{default:t}}function s(t,e,n,i,o,a,r){try{var s=t[a](r),u=s.value}catch(c){return void n(c)}s.done?e(u):Promise.resolve(u).then(i,o)}function u(t){return function(){var e=this,n=arguments;return new Promise((function(i,o){var a=t.apply(e,n);function r(t){s(a,i,o,r,u,"next",t)}function u(t){s(a,i,o,r,u,"throw",t)}r(void 0)}))}}function c(t){return g(t)||d(t)||l(t)||f()}function f(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function l(t,e){if(t){if("string"===typeof t)return p(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(t,e):void 0}}function d(t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function g(t){if(Array.isArray(t))return p(t)}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function m(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function h(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?m(Object(n),!0).forEach((function(e){v(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function v(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var b=t.getSystemInfoSync(),y={computed:h({},(0,o.mapState)({userInfo:"userInfo"})),data:function(){return{showconfirmbar:!1,placeholder:"发信息...",statusBarHeight:b.statusBarHeight,sticky:{enable:!0},height:44,listtip:["让手书温暖你最熟悉的陌生人"],srcleft:"../../../static/treehole/my/back.png",picIcon:"../../static/treehole/xinxi/sixin-pic.png",imgsize:46,talkList:[],ajax:{rows:20,page:1,flag:!0,loading:!0,loadText:"正在获取消息",more:1},limitType:["png","jpg","jpeg","webp","gif","image"],header:{token:t.getStorageSync("token")},action:a.default.apiUrl+"/upload",content:"",biu:{priMsgStatus:0}}},mounted:function(){var t=this;this.$nextTick((function(){t.getHistoryMsg()}))},onLoad:function(t){this.height=this.height+this.statusBarHeight-1;var e=t.params||t.payload;try{var n=JSON.parse(decodeURIComponent(e))}catch(i){n=JSON.parse(e)}this.biu=n},onPullDownRefresh:function(){this.getFirstMsg(),setTimeout((function(){t.stopPullDownRefresh()}),1e3)},onPageScroll:function(t){t.scrollTop<5&&this.getHistoryMsg()},methods:{formatMssageTime:function(t,e){return 0===e?t.messageTime:this.talkList[e].messageTime===this.talkList[e-1].messageTime?"":t.messageTime},getFirstMsg:function(){t.showLoading({mask:!0,title:"正在加载"}),this.ajax.page=1;var e=this,n="/user/friend/message/list";e.$http.post(n,{friend:e.biu.friend,page:e.ajax.page,size:e.ajax.rows,read:2}).then((function(n){var i=n.data;if(console.info("历史信息111::",i.data.list),200===i.code){e.ajax.more=i.data.more,data=i.data.list,data.reverse();var o="";o="#msg-".concat(data[data.length-1].disc),e.talkList=[].concat(c(data),c(e.talkList)),e.$nextTick((function(){e.setPageScrollTo(o),e.hideLoadTips(!0),0===i.data.more||(e.ajax.page++,setTimeout((function(){e.ajax.flag=!0}),200))}))}else 501===i.code&&setTimeout((function(){t.hideLoading(),e.$store.dispatch("Logout")}),800)})).catch((function(t){t.message})).finally((function(){t.hideLoading()}))},goBack:function(){t.navigateBack({})},fixed:function(){},unfixed:function(){},getHistoryMsg:function(){var e=this;if(e.ajax.flag){var n=function(){var n=u(i.default.mark((function n(){var o,a,r;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:e.hideLoadTips(),e.ajax.flag=!1,o=[],a={friend:e.biu.friend,page:e.ajax.page,size:e.ajax.rows,read:2},r="/user/friend/message/list",e.$http.post(r,a).then((function(n){var i=n.data;if(200===i.code){e.ajax.more=i.data.more,o=i.data.list,o.reverse(),e.talkList=[].concat(c(o),c(e.talkList));e.ajax.page>1?"#msg-".concat(e.talkList[0].disc):"#msg-".concat(o[o.length-1].disc),e.$nextTick((function(){t.pageScrollTo({scrollTop:2e6,duration:0})}))}else 501===i.code&&setTimeout((function(){t.hideLoading(),e.$store.dispatch("Logout")}),800)})).catch((function(t){t.message})).finally((function(){}));case 6:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();n()}},setPageScrollTo:function(e){var n=this,i=t.createSelectorQuery().in(this).select(e);i.boundingClientRect((function(e){t.pageScrollTo({scrollTop:n.height,duration:0})})).exec()},handlePreImage:function(e){t.previewImage({urls:[e]})},hideLoadTips:function(t){this.ajax.loadText=this.biu.name},chooseImage:function(){var e=this;if(0===this.userInfo.priMsgStatus)return this.$u.toast("请开启私信开关"),!1;if(0===this.biu.priMsgStatus)return this.$u.toast("对方已关闭私信"),!1;var n=null;n=new Promise((function(e,n){t.chooseImage({count:1,sourceType:["album","camera"],sizeType:["original","compressed"],success:e,fail:n})})),n.then((function(t){t.tempFiles.map((function(t,n){e.checkFileExt(t)&&(e.fileTemp=t.path)})),e.uploadFile()})).catch((function(t){console.info("error::",t)}))},uploadFile:function(){if(this.fileTemp){t.showLoading({mask:!0,title:"图片上传中..."});var e=this;t.uploadFile({url:e.action,filePath:e.fileTemp,name:"file",header:e.header,success:function(n){t.hideLoading();var i=e.$u.test.jsonString(n.data)?JSON.parse(n.data):n.data;[200,201,204].includes(n.statusCode)?503===i.code?t.showToast({icon:"error",title:i.message,duration:3e3}):(console.info("上传成功::",i),e.send_img(i.data.url)):(e.$u.toast("上传失败，请重试"),e.fileUrl="")},fail:function(n){t.hideLoading(),e.$u.toast("上传失败，请重试"),e.fileUrl=""},complete:function(t){}})}},checkFileExt:function(t){var e=!1,n="",i=/.+\./;return n=t.path.replace(i,"").toLowerCase(),e=this.limitType.some((function(t){return t.toLowerCase()===n})),e||this.$u.toast("不允许选择".concat(n,"格式的文件")),e},send_img:function(e){var n={friend:this.biu.friend,images:e,content:"",contentType:"image"};console.info("requestParam::",n);var i=this,o="/user/friend/message/send";i.$http.post(o,n).then((function(o){var a=o.data;200===a.code?(n=h(h({},n),{},{content:e,id:(new Date).getTime(),is_self:1,image:i.userInfo.image}),i.talkList.push(n)):501===a.code?setTimeout((function(){t.hideLoading(),i.$store.dispatch("Logout")}),800):t.showToast({icon:"error",title:n.message,duration:3e3})})).catch((function(t){i.$u.toast(t.message)})).finally((function(){i.$nextTick((function(){i.content="",t.pageScrollTo({scrollTop:999999,duration:0})}))}))},send:function(){var e=this;this.content?(t.showLoading({title:"正在发送"}),setTimeout((function(){t.hideLoading();var n={friend:e.biu.friend,images:"",content:e.content,contentType:"text",messageTime:"刚刚"};console.info("requestParam::",n);var i=e,o="/user/friend/message/send";i.$http.post(o,n).then((function(e){var o=e.data;console.info("_result:::::::::",o),200===o.code?(n=h(h({},n),{},{id:(new Date).getTime(),is_self:1,image:i.userInfo.image}),i.talkList.push(n)):501===o.code?setTimeout((function(){t.hideLoading(),i.$store.dispatch("Logout")}),800):i.$u.toast(o.message)})).catch((function(t){i.$u.toast(t.message)})).finally((function(){i.$nextTick((function(){i.content="",t.pageScrollTo({scrollTop:999999,duration:0})}))}))}),1e3)):t.showToast({title:"请输入有效的内容",icon:"none"})},link2biu:function(e){if(console.info("sixin::2::biu::",e),1===e.is_self){var n={friend:e.id};t.navigateTo({url:"../user/biu?params="+encodeURIComponent(JSON.stringify(n))})}else{var i=h({},this.biu);t.navigateTo({url:"../user/biu?params="+encodeURIComponent(JSON.stringify(i))})}},withdraw:function(e,n){var i=this,o=this;e.is_self?t.showModal({title:"提示",content:"是否撤回消息？",success:function(i){if(i.confirm){var a="/user/friend/message/cancel";o.$http.post(a,{messageId:e.messageId}).then((function(e){var i=e.data;console.info("_result:::::::::",e),200===i.code?o.talkList.splice(n,1):501===i.code?setTimeout((function(){t.hideLoading(),o.$store.dispatch("Logout")}),800):o.$u.toast(i.message)})).catch((function(t){o.$u.toast(t.message)})).finally((function(){}))}}}):t.setClipboardData({data:e.content,success:function(){i.$u.toast("复制成功")}})},copy:function(){var e=this;t.setClipboardData({data:"record.content",success:function(){e.$u.toast("复制成功")}})}}};e.default=y}).call(this,n("543d")["default"])}},[["df0f","common/runtime","common/vendor"]]]);